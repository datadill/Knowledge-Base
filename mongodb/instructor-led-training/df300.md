# DF300

## Stages

### $project

* Good for creating brand new fields or renaming fields
* Only sends new fields you specify from one stage to the next

### $set

* $set is very similar to project, but the major difference is that $set will forward ALL of the fields of the document as well as the ones you $set
* From a performance perspective, the instructor said that $project is not necessarily faster than $set even though you are likely returning less fields in $project

### $group

* Roughly equivalent to GROUP BY in SQL
* Groups documents by a "group key"
* Output is one document per group
* Additional fields can contain results of accumulator expressions

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

* Common $group accumulators
  * $addToSet, $avg, $first, $last, $max, $min, $mergeObjects, $push, $stdDevSamp, $sum
  * Also.. $bucket, $bucketAuto, $facet
    * $bucket is good to segregate data
      * ex. Group data by month
  * $sortByCount
    * Really common for DBAs and developers
    * Returns a frequency count of a field across all of your documents
  * $unwind
    * Opposite of $group, it will unwind an array into multiple documents with the same \_id
      * Because this is a stage during the pipeline in memory, this does not cause any issues

### $lookup

* Like a left outer join, but much more closely aligns to a nested select in terms of performance
  * MongoDB is NOT a relational database!
* Good for analytic purposes mostly
  * Their is one edge case that is acceptable in OLTP applications..
    * ex. When one collection is very static and another is extremely active (updates every few milliseconds)
* No referential integrity is enforced with this operation
* If their is more than one match on the right side of the join, it will put the results into an array
* For each document in the left side of the join, you will have to iteratively scan the right side collection
  * You MUST index the foreign field (right side)
  * It is also recommended to index the local field (left side)
* If their is no match, their is nothing to attach the join to and thus that field will not be attached
* Be careful of cross joining NULL values as NULL is considered a value in Mongo

